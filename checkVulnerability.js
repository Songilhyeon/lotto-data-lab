#!/usr/bin/env node
/**
 * Next.js / React ì·¨ì•½ ë²„ì „ ìë™ ì ê²€ ìŠ¤í¬ë¦½íŠ¸ (ESM ë²„ì „)
 */

import fs from "fs";
import path from "path";
import semver from "semver";
import { fileURLToPath } from "url";

// __dirname ëŒ€ì²´ (ESM í™˜ê²½)
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// package.json ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
const pkgPath = path.join(__dirname, "package.json");
if (!fs.existsSync(pkgPath)) {
  console.error("âŒ package.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  process.exit(1);
}

const pkg = JSON.parse(fs.readFileSync(pkgPath, "utf8"));
const deps = {
  ...pkg.dependencies,
  ...pkg.devDependencies,
};

// -------------------------------------------------------
// ğŸ”¥ ì·¨ì•½í•œ ë²„ì „ ë²”ìœ„ (ê³µì‹ CVE ê¸°ë°˜)
// -------------------------------------------------------
const vulnerableRanges = {
  next: [
    "<15.0.5 || 15.1.x < 15.1.9 || 15.2.x < 15.2.6 || 15.3.x < 15.3.6 || 15.4.x < 15.4.8 || 15.5.x < 15.5.7 || >=16.0.0 <16.0.7",
  ],
  react: ["<18.3.3"],
  "react-server-dom-webpack": ["<18.3.3"],
};

// -------------------------------------------------------
const recommendedVersions = {
  next: "15.5.7",
  react: "18.3.3",
  "react-server-dom-webpack": "18.3.3",
};

// -------------------------------------------------------
function checkPackage(name) {
  const installed = deps[name];
  if (!installed) return null;

  const ranges = vulnerableRanges[name];
  const safeVersion = recommendedVersions[name];

  for (const range of ranges) {
    const version = semver.coerce(installed); // ESMì—ì„œë„ ì •ìƒ ì‘ë™
    if (version && semver.satisfies(version, range)) {
      return {
        name,
        installed,
        vulnerable: true,
        recommended: safeVersion,
      };
    }
  }

  return {
    name,
    installed,
    vulnerable: false,
    recommended: null,
  };
}

// -------------------------------------------------------
console.log("\nğŸ” Next.js / React ë³´ì•ˆ ì·¨ì•½ì  ìë™ ê²€ì‚¬ ê²°ê³¼");
console.log("--------------------------------------------------");

const targets = ["next", "react", "react-server-dom-webpack"];
let hasVulnerable = false;

targets.forEach((t) => {
  const result = checkPackage(t);
  if (!result) return;

  if (result.vulnerable) {
    hasVulnerable = true;
    console.log(
      `âŒ [ì·¨ì•½] ${t}@${result.installed} â†’ ì—…ë°ì´íŠ¸ í•„ìš”! (ê¶Œì¥: ${result.recommended})`
    );
  } else {
    console.log(`âœ… [ì•ˆì „] ${t}@${result.installed}`);
  }
});

if (!hasVulnerable) {
  console.log("\nâœ¨ ëª¨ë“  íŒ¨í‚¤ì§€ê°€ ì•ˆì „í•œ ë²„ì „ì…ë‹ˆë‹¤!\n");
} else {
  console.log("\nâš ï¸ ì·¨ì•½ íŒ¨í‚¤ì§€ê°€ ìˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ ì—…ë°ì´íŠ¸ í•˜ì„¸ìš”!");
  console.log("ì˜ˆì‹œ: npm install next@latest react@latest\n");
}

process.exit(hasVulnerable ? 1 : 0);
